<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Soccer &mdash; Website by Colorlib</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="fonts/icomoon/style.css" />

    <link rel="stylesheet" href="css/bootstrap/bootstrap.css" />
    <link rel="stylesheet" href="css/jquery-ui.css" />
    <link rel="stylesheet" href="css/owl.carousel.min.css" />
    <link rel="stylesheet" href="css/owl.theme.default.min.css" />
    <link rel="stylesheet" href="css/owl.theme.default.min.css" />

    <link rel="stylesheet" href="css/jquery.fancybox.min.css" />

    <link rel="stylesheet" href="css/bootstrap-datepicker.css" />

    <link rel="stylesheet" href="fonts/flaticon/font/flaticon.css" />

    <link rel="stylesheet" href="css/aos.css" />

    <link rel="stylesheet" href="css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <style>
      .seat-map {
        display: grid;
        gap: 10px;
      }

      .seat-row {
        display: flex;
        justify-content: center;
        gap: 5px;
      }

      .seat {
        width: 40px;
        height: 40px;
        border: 1px solid #ccc;
        cursor: pointer;
        text-align: center;
        line-height: 40px;
        border-radius: 5px;
        background-color: lightgreen;
        margin-bottom: 5px;
      }

      .seat.selected {
        background-color: lightblue;
      }

      .seat.unavailable {
        background-color: lightgray;
        cursor: default;
      }

      .screen {
        background-color: #333;
        color: white;
        text-align: center;
        padding: 10px;
        margin-bottom: 20px;
        border-radius: 5px;
        font-size: 1.2rem;
        height: 100px;
      }

      .legend {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 20px;
      }

      .legend .row {
        display: flex;
        align-items: center;
      }

      .legend .seat {
        margin-right: 5px;
      }

      .booking-details {
        margin-top: 20px;
        text-align: center;
      }

      .booking-details h3 {
        margin-bottom: 10px;
      }

      .booking-details button {
        margin-top: 10px;
        width: 100%;
        max-width: 200px;
        margin-left: auto;
        margin-right: auto;
      }

      .modal-body {
        padding: 20px;
      }

      @media (max-width: 768px) {
        .col-md-8,
        .col-md-4 {
          flex: 1 1 100%;
        }
      }

      .modal-dialog {
        max-width: 1000px;
        /* Chiều rộng tối đa */
        width: 1000px;
        /* Chiều rộng mặc định */
      }

      .modal-content {
        width: 100%;
        max-width: 900px;
        height: 650px;
      }
    </style>
  </head>

  <body>
    <div class="site-wrap">
      <div class="site-mobile-menu site-navbar-target">
        <div class="site-mobile-menu-header">
          <div class="site-mobile-menu-close">
            <span class="icon-close2 js-menu-toggle"></span>
          </div>
        </div>
        <div class="site-mobile-menu-body"></div>
      </div>

      <header class="site-navbar py-4" role="banner">
        <div class="container">
          <div class="d-flex align-items-center">
            <div class="site-logo">
              <a href="index.html">
                <img src="images/logo.png" alt="Logo" />
              </a>
            </div>
            <div class="ml-auto">
              <nav
                class="site-navigation position-relative text-right"
                role="navigation"
              >
                <ul
                  class="site-menu main-menu js-clone-nav mr-auto d-none d-lg-block"
                >
                  <li><a href="index.html" class="nav-link">Home</a></li>
                  <li><a href="matches.html" class="nav-link">Matches</a></li>
                  <li><a href="players.html" class="nav-link">Players</a></li>
                  <li class="active">
                    <a href="booking.html" class="nav-link">Booking</a>
                  </li>
                  <li class="dropdown">
                    <a href="#" class="nav-link user-menu">
                      <span class="icon-user"></span>
                      <span class="user-email">Guest</span>
                      <!-- Hiển thị email hoặc "Guest" -->
                    </a>
                    <ul class="dropdown-menu">
                      <li id="loginOption">
                        <a
                          href="login.html"
                          class="nav-link"
                          data-page="login.html"
                          >Login</a
                        >
                      </li>
                      <li id="registerOption">
                        <a
                          href="register.html"
                          class="nav-link"
                          data-page="register.html"
                          >Register</a
                        >
                      </li>
                      <li id="logoutOption" style="display: none">
                        <a href="#" class="nav-link" onclick="handleLogout()"
                          >Logout</a
                        >
                      </li>
                    </ul>
                  </li>
                </ul>
              </nav>

              <a
                href="#"
                class="d-inline-block d-lg-none site-menu-toggle js-menu-toggle text-black float-right text-white"
                ><span class="icon-menu h3 text-white"></span
              ></a>
            </div>
          </div>
        </div>
      </header>

      <div
        class="hero overlay"
        style="background-image: url('images/bg_3.jpg')"
      >
        <div class="container">
          <div class="row align-items-center">
            <div class="col-lg-5 mx-auto text-center">
              <h1 class="text-white">BOOKING</h1>
            </div>
          </div>
        </div>
      </div>

      <div class="site-section bg-dark">
        <div class="container">
          <div class="row">
            <div class="col-12 title-section">
              <h2 class="heading">Upcoming Match</h2>
            </div>

            <!-- Booking Modal -->
            <div
              class="modal fade"
              id="bookingModal"
              tabindex="-1"
              aria-labelledby="bookingModalLabel"
              aria-hidden="true"
            >
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="bookingModalLabel">Đặt Vé</h5>
                    <button
                      type="button"
                      class="btn-close"
                      data-bs-dismiss="modal"
                      aria-label="Close"
                    >
                      X
                    </button>
                  </div>
                  <div class="modal-body">
                    <div class="container">
                      <div class="row">
                        <div class="col-md-8">
                          <div class="seat-map">
                            <div class="screen">Sân bóng</div>
                            <div class="seats"></div>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="legend">
                            <div class="row">
                              <div class="seat available"></div>
                              <span>Ghế trống</span>
                            </div>
                            <div class="row">
                              <div class="seat selected"></div>
                              <span>Ghế đã chọn</span>
                            </div>
                            <div class="row">
                              <div class="seat unavailable"></div>
                              <span>Ghế không có</span>
                            </div>
                          </div>
                          <div class="booking-details mt-4">
                            <h3>Thông tin đặt vé</h3>
                            <div class="selected-seats">
                              Ghế đã chọn: <span id="selected-seats"></span>
                            </div>
                            <div class="total-price">
                              Tổng giá: <span id="total-price">0</span> VND
                            </div>
                            <button
                              id="book-button"
                              class="btn btn-primary"
                              disabled
                            >
                              Đặt vé
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-lg-6 mb-4">
              <div class="bg-light p-4 rounded">
                <div class="widget-body">
                  <div class="widget-vs">
                    <div
                      class="d-flex align-items-center justify-content-around justify-content-between w-100"
                    >
                      <div class="team-1 text-center">
                        <img src="images/logo_1.png" alt="Image" />
                        <h3>Arsenal</h3>
                      </div>
                      <div>
                        <span class="vs"><span>VS</span></span>
                      </div>
                      <div class="team-2 text-center">
                        <img src="images/logo_2.png" alt="Image" />
                        <h3>Manchester United</h3>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="text-center widget-vs-contents mb-4">
                  <h4>World Cup League</h4>
                  <p class="mb-5">
                    <span class="d-block">October 27th, 2024</span>
                    <span class="d-block">14:25 PM GMT+0</span>
                    <strong class="text-primary">New Euro Arena</strong>
                  </p>
                  <button
                    type="button"
                    class="btn btn-primary"
                    data-bs-toggle="modal"
                    data-bs-target="#bookingModal"
                    data-match-id="1"
                  >
                    Book Tickets
                  </button>
                  <button class="btn btn-secondary">View Details</button>
                </div>
              </div>
            </div>
            <div class="col-lg-6 mb-4">
              <div class="bg-light p-4 rounded">
                <div class="widget-body">
                  <div class="widget-vs">
                    <div
                      class="d-flex align-items-center justify-content-around justify-content-between w-100"
                    >
                      <div class="team-1 text-center">
                        <img src="images/logo_3.png" alt="Image" />
                        <h3>Liverpool</h3>
                      </div>
                      <div>
                        <span class="vs"><span>VS</span></span>
                      </div>
                      <div class="team-2 text-center">
                        <img src="images/logo_4.png" alt="Image" />
                        <h3>Manchester City</h3>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="text-center widget-vs-contents mb-4">
                  <h4>World Cup League</h4>
                  <p class="mb-5">
                    <span class="d-block">October 26th, 2024</span>
                    <span class="d-block">9:25 AM GMT+0</span>
                    <strong class="text-primary">New Euro Arena</strong>
                  </p>
                  <button
                    type="button"
                    class="btn btn-primary"
                    data-bs-toggle="modal"
                    data-bs-target="#bookingModal"
                    data-match-id="3"
                  >
                    Book Tickets
                  </button>
                  <button class="btn btn-secondary">View Details</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <footer class="footer-section">
        <div class="container">
          <div class="row">
            <div class="col-lg-3">
              <div class="widget mb-3">
                <h3>News</h3>
                <ul class="list-unstyled links">
                  <li><a href="#">All</a></li>
                  <li><a href="#">Club News</a></li>
                  <li><a href="#">Media Center</a></li>
                  <li><a href="#">Video</a></li>
                  <li><a href="#">RSS</a></li>
                </ul>
              </div>
            </div>
            <div class="col-lg-3">
              <div class="widget mb-3">
                <h3>Tickets</h3>
                <ul class="list-unstyled links">
                  <li><a href="#">Online Ticket</a></li>
                  <li><a href="#">Payment and Prices</a></li>
                  <li><a href="#">Contact &amp; Booking</a></li>
                  <li><a href="#">Tickets</a></li>
                  <li><a href="#">Coupon</a></li>
                </ul>
              </div>
            </div>
            <div class="col-lg-3">
              <div class="widget mb-3">
                <h3>Matches</h3>
                <ul class="list-unstyled links">
                  <li><a href="#">Standings</a></li>
                  <li><a href="#">World Cup</a></li>
                  <li><a href="#">La Lega</a></li>
                  <li><a href="#">Hyper Cup</a></li>
                  <li><a href="#">World League</a></li>
                </ul>
              </div>
            </div>
            <div class="col-lg-3">
              <div class="widget mb-3">
                <h3>Social</h3>
                <ul class="list-unstyled links">
                  <li><a href="#">Twitter</a></li>
                  <li><a href="#">Facebook</a></li>
                  <li><a href="#">Instagram</a></li>
                  <li><a href="#">Youtube</a></li>
                </ul>
              </div>
            </div>
          </div>

          <div class="row text-center">
            <div class="col-md-12">
              <div class="pt-5">
                <p>
                  <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
                  Copyright &copy;
                  <script>
                    document.write(new Date().getFullYear());
                  </script>
                  All rights reserved | This template is made with
                  <i class="icon-heart" aria-hidden="true"></i> by
                  <a href="https://colorlib.com" target="_blank">Colorlib</a>
                  <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
                </p>
              </div>
            </div>
          </div>
        </div>
      </footer>
    </div>
    <!-- .site-wrap -->

    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/jquery-migrate-3.0.1.min.js"></script>
    <script src="js/jquery-ui.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/owl.carousel.min.js"></script>
    <script src="js/jquery.stellar.min.js"></script>
    <script src="js/jquery.countdown.min.js"></script>
    <script src="js/bootstrap-datepicker.min.js"></script>
    <script src="js/jquery.easing.1.3.js"></script>
    <script src="js/aos.js"></script>
    <script src="js/jquery.fancybox.min.js"></script>
    <script src="js/jquery.sticky.js"></script>
    <script src="js/jquery.mb.YTPlayer.min.js"></script>
    <script>
      const seatsContainer = document.querySelector('.seats');
      const selectedSeatsEl = document.getElementById('selected-seats');
      const totalPriceEl = document.getElementById('total-price');
      const bookButton = document.getElementById('book-button');
      let selectedSeats = [];
      let totalPrice = 0;
      const seatPrice = 100000;
      const apiUrl = 'http://localhost:3001/api/ticket/bookTicket';
      const getSeatApiUrl = 'http://localhost:3001/api/seat/getSeatMatch/';
      let currentMatchId = null;
      let userId = 3;
      let seatData = [];

const bookingModal = document.getElementById('bookingModal');

bookingModal.addEventListener('show.bs.modal', async (event) => {
  const button = event.relatedTarget;
  currentMatchId = parseInt(button.dataset.matchId, 10);
  seatsContainer.innerHTML = '';
  selectedSeats = [];
  totalPrice = 0;
  updateBookingDetails();
  await loadSeats();
});

async function loadSeats() {
  try {
    const url = `${getSeatApiUrl}${currentMatchId}`;
    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'Accept': 'application/json'
      },
    });

    if (!response.ok) {
      let errorMessage = `Error fetching seat data: ${response.status} ${response.statusText}`;
      try {
        const errorData = await response.json();
        errorMessage = errorData.message || errorMessage;
      } catch (jsonError) {
        //Handle cases where the response isn't valid JSON
        console.error("Error parsing error response:", jsonError);
      }
      throw new Error(errorMessage);
    }

    const data = await response.json();
    seatData = processSeatData(data.result);
    createSeatMap();
  } catch (error) {
    console.error("Error:", error);
    alert(`Error loading seats: ${error.message}`);
  }
}

function processSeatData(seatDataFromApi) {
  const seats = [];
  let currentRow = [];
  seatDataFromApi.forEach(seat => {
    currentRow.push({
        seat_id: seat.seat_id,
        seat_number: seat.seat_number,
        available: seat.status === 'Available'
    });
    if (currentRow.length === 10) {
      seats.push(currentRow);
      currentRow = [];
    }
  });
  //Thêm hàng còn lại nếu không đủ 10 ghế
  if (currentRow.length > 0) {
    seats.push(currentRow);
  }
  return seats;
}

function createSeatMap() {
if (!seatData || seatData.length === 0) {
  seatsContainer.innerHTML = '<p>No seat data available.</p>';
  return;
}

seatData.forEach(row => {
  const rowDiv = document.createElement('div');
  rowDiv.classList.add('seat-row');
  row.forEach(seat => {
    const seatDiv = createSeatElement(seat);
    rowDiv.appendChild(seatDiv);
  });
  seatsContainer.appendChild(rowDiv);
});
}

function createSeatElement(seat) {
  const seatDiv = document.createElement('div');
  seatDiv.classList.add('seat', seat.available ? 'available' : 'unavailable');
  seatDiv.dataset.seatId = seat.seat_id;
  seatDiv.textContent = `A${seat.seat_id}`; 
  seatDiv.addEventListener('click', handleSeatClick);
  return seatDiv;
}


function handleSeatClick(event) {
  const seat = event.target;
  if (seat.classList.contains('unavailable')) return;

  const seatId = parseInt(seat.dataset.seatId, 10);

  const index = selectedSeats.indexOf(seatId);
  if (index > -1) {
    seat.classList.remove('selected');
    selectedSeats.splice(index, 1);
    totalPrice -= seatPrice;
  } else {
    seat.classList.add('selected');
    selectedSeats.push(seatId);
    totalPrice += seatPrice;
  }
  updateBookingDetails();
}

function updateBookingDetails() {
  selectedSeatsEl.textContent = selectedSeats.join(', ');
  totalPriceEl.textContent = totalPrice.toLocaleString(); // Format number with commas
  bookButton.disabled = selectedSeats.length === 0;
}

bookButton.addEventListener('click', async () => {
  if (selectedSeats.length === 0) {
    alert("Please select seats!");
    return;
  }

  try {
    for (const seatId of selectedSeats) {
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          match_id: currentMatchId,
          user_id: userId,
          seat_id: seatId 
        }),
      });

      if (!response.ok) {
        const errorData = await response.json();
        const errorMessage = errorData.message || `Booking failed for seat ${seatId}: ${response.status} ${response.statusText}`;
        throw new Error(errorMessage);
      }
      console.log(`Seat ${seatId} booked successfully.`);
    }

    alert("Booking successful!");
    location.reload();
  } catch (error) {
    alert(`Error: ${error.message}`);
  }
});
</script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>

    <script src="js/main.js"></script>
  </body>
</html>
